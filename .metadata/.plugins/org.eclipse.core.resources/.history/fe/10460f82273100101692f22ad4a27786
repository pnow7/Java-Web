package openapi;

import javax.naming.Context;

import javax.naming.InitialContext;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;

import javax.sql.DataSource;

import openapi.ApiDataDTO.Item;

public class ApiDataDAO {
	
	private Connection con;
	private PreparedStatement pstmt;
	private DataSource dataFactory;
	
	public ApiDataDAO() {
		try {
			Context ctx = new InitialContext();
			Context envContext = (Context)ctx.lookup("java:/comp/env");
			dataFactory = (DataSource)envContext.lookup("jdbc/oracle");
		} catch(Exception e) {
			e.printStackTrace();
		}
	}
	/**
	 * t_cross 테이블에 저장
	 * @param data
	 * @return
	 */

	public int insertData(ApiDataDTO data) {
		int result = 0;
		
		try {
			con = dataFactory.getConnection();
			
			String sql = "insert into t_cross("
					+ "REGION_CD, "
					+ "INT_PLAN_NO, "
					+ "HOLY_PLAN_DD, "
					+ "INT_NO, "
					+ "HOLY_PLAN_MM, "
					+ "INT_NM, "
					+ "COLLCT_DTIME, "
					+ "PLAN_SN)"
					+ "values (?,?,?,?,?,?,?,?)";
			List<Item> itemList = data.getItemList();
			int count = 0;
			for(Item item : itemList) {
				pstmt = con.prepareStatement(sql);
				System.out.println(sql);
				System.out.println(
						item.getRegionCd()+":" +
						item.getRegionCd() +":"+
						item.getIntPlanNo() +":"+
						item.getHolyPlanDd() +":"+
						item.getIntNo() +":"+
						item.getHolyPlanMm() +":"+
						item.getIntNm() +":"+
						item.getCollctDtime() +":"+
						item.getPlanSn()
				);
				pstmt.setString(1,  item.getRegionCd());
				pstmt.setString(2,  item.getIntPlanNo());
				pstmt.setString(3,  item.getHolyPlanDd());
				pstmt.setString(4,  item.getIntNo());
				pstmt.setString(5,  item.getHolyPlanMm());
				pstmt.setString(6,  item.getIntNm());
				pstmt.setString(7,  item.getCollctDtime());
				pstmt.setString(8,  item.getPlanSn());
				
				result = pstmt.executeUpdate();
				
				if(result < 1) throw new Exception("입력 중 오류 발생");
				if(count++ > 10) break;
			}
			
			pstmt.close();
			con.close();
		} catch(Exception e) {
			System.out.println("SQL 구문 실행 중 예외 발생:" + e.toString());
		}
		return result;
	}
	
	public List<Item> getList() {
		List<Item> itemList = new ArrayList<>();
		
		try {
			String sql = "select * from t_cross";
			con = dataFactory.getConnection();
			
			pstmt = con.prepareStatement(sql);
			ResultSet rs = pstmt.executeQuery();
			
			while(rs.next()) {
				Item item = new Item();
				item.setRegionCd(rs.getString("REGION_CD"));
				item.setIntPlanNo(rs.getString("INT_PLAN_NO"));
				item.setHolyPlanDd(rs.getString("HOLY_PLAN_DD"));
				item.setIntNo(rs.getString("INT_NO"));
				item.setHolyPlanMm(rs.getString("HOLY_PLAN_MM"));
				item.setIntNm(rs.getString("INT_NM"));
				item.setCollctDtime(rs.getString("COLLCT_DTIME"));
				item.setPlanSn(rs.getString("PLAN_SN"));
				
				itemList.add(item);
			}
			
			rs.close();
			pstmt.close();
			con.close();
		} catch(Exception e) {
			System.out.println("조회 중 에러 발생");
		}
		
		return itemList;
	}
}
